<!DOCTYPE html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Speaker</title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--CSS-->
  <link href="../example/styles.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <script src="../main.js"></script>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”ˆ</text></svg>" />
  <!--<script src="https://www.unpkg.com/sound-check"></script>-->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"
    integrity="sha256-ErZ09KkZnzjpqcane4SCyyHsKAXMvID9/xwbl/Aq1pc=" crossorigin="anonymous"></script> -->
</head>

<body>
  <div class="container-fluid">
    <h1>Speaker Page</h1>
    <p class="lead">
      Lorem ipsum dolor sit amet, consectetur adipisicing elit. Officia maxime sapiente
      repudiandae est, magnam ex sint iure quo porro ullam debitis inventore at temporibus quod
      ducimus nesciunt dolorem laboriosam. Eius!
    </p>

    <div class="row">
      <div class="col-md-2 options-panel">
        <div class="row">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="flexSwitchCheckVolume" />
            <label class="form-check-label" for="flexSwitchCheckVolume">Volume</label>
          </div>
        </div>
        <div class="row">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="flexSwitchCheckIR" checked />
            <label class="form-check-label" for="flexSwitchCheckIR">Impulse Response</label>
          </div>
        </div>
        <div class="row">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="flexSwitchCheckDownload" checked />
            <label class="form-check-label" for="flexSwitchCheckDownload">Download Data</label>
          </div>
        </div>
        <div class="row">
          <input type="number" id="numCalibrationRoundsInput" class="form-control" value="1" />
          <label class="form-label" for="numCalibrationRoundsInput">Calibration Rounds</label>
        </div>
        <div class="row">
          <input type="number" id="numCalibrationNodesInput" class="form-control" value="1" />
          <label class="form-label" for="numCalibrationNodesInput">Calibration Nodes</label>
        </div>
        <div class="row">
          <button id="calibrationBeginButton" type="button" class="btn btn-primary">
            Calibrate
          </button>
        </div>
        <div class="row">
          <input id="csv-file" type="file" />
        </div>
        <div class="row">
          <div id="display"></div>
        </div>
      </div>

      <div class="col-md-10">
        <div class="row">
          <div class="d-flex align-items-center d-none" id="spinner">
            <strong>Calibrating Volume...</strong>
            <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div>
          </div>
          <h4 id="calibrationResult" class="d-none"></h4>
        </div>
        <div class="row">
          <div id="d3-select">
            <div id="generated-signal-chart"></div>
          </div>
        </div>
        <div class="row">
          <div>
            <div id="captured-signal-chart""></div>
          </div>
        </div>
        <div class=" row">
              <div>
                <div id="ir-chart"></div>
              </div>
            </div>
          </div>
        </div>

        <script>
          const flexSwitchCheckIR = document.getElementById('flexSwitchCheckIR');
          const flexSwitchCheckVolume = document.getElementById('flexSwitchCheckVolume');
          const csvUpload = document.getElementById('csv-file');
          const sendToServerButton = document.getElementById('sendToServerButton');

          const { Speaker, VolumeCalibration, ImpulseResponseCalibration } = speakerCalibrator;

          const normalize = (min, max) => {
            var delta = max - min;
            return (val) => {
              return (val - min) / delta;
            };
          }

          const useIRResult = async (invertedIR) => {
            // invertedIRNorm = invertedIR
            invertedIRNorm = invertedIR // invertedIR.map(normalize(-1, 1))
            console.log({ invertedIRNorm })
            //invertedIRNorm = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,]
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioCtx = new AudioContext();
            const audioFile = fetch("./Queen-Bohemian_Rhapsody.wav")
              .then(response => response.arrayBuffer())
              .then(buffer => audioCtx.decodeAudioData(buffer))
              .then(async buffer => {
                buffer.channelCount = 1;
                buffer.numberOfChannels = 1;
                const track = audioCtx.createBufferSource(1, buffer.length, audioCtx.sampleRate);
                track.buffer = buffer;
                track.channelCount = 1;

                console.log({ buffer })
                const myArrayBuffer = audioCtx.createBuffer(1, invertedIRNorm.length, audioCtx.sampleRate);
                console.log(invertedIRNorm.length/audioCtx.sampleRate)
                console.log({ myArrayBuffer })

                // Fill the buffer with white noise;
                // just random values between -1.0 and 1.0
                // This gives us the actual ArrayBuffer that contains the data
                const nowBuffering = myArrayBuffer.getChannelData(0);
                for (let i = 0; i < myArrayBuffer.length; i++) {
                  // Math.random() is in [0; 1.0]
                  // audio needs to be in [-1.0; 1.0]
                  nowBuffering[i] = invertedIRNorm[i];
                }
                //convolver.normalize = false
                //convolver.buffer = myArrayBuffer;
                const convolver = audioCtx.createConvolver();
                convolver.normalize = false;
                convolver.channelCount = 1;
                convolver.buffer = myArrayBuffer;

                console.log({ convolver })
                console.log({ track })
                //convolver.connect(track)
                track.connect(convolver);
                convolver.connect(audioCtx.destination)
                //track.connect(audioCtx.destination)
                console.log("Starting Audio")
                track.start();
              });
          }

          const handleFileUpload = (e) => {
            const calibratorParams = {
              numCalibrationRounds: 0,
              numCalibrationNodes: 0,
              download: false,
            };

            console.log("Hey")
            const f = e.target.files[0];
            if (f) {
              e.preventDefault();
              const reader = new FileReader();

              reader.onload = async (e) => {
                console.log("Hello World")
                const text = e.target.result;
                const testIRCalibration = new ImpulseResponseCalibration(calibratorParams);
                testIRCalibration.sourceSamplingRate = 96000;
                await testIRCalibration.sendToServerForProcessing(text)
                console.log(testIRCalibration.invertedImpulseResponse)
                await useIRResult(testIRCalibration.invertedImpulseResponse)
              };

              reader.readAsText(f);
            }
          }

          csvUpload.addEventListener('change', handleFileUpload);

          flexSwitchCheckIR.onchange = () => {
            flexSwitchCheckVolume.checked = !flexSwitchCheckIR.checked;
          };

          flexSwitchCheckVolume.onchange = () => {
            flexSwitchCheckIR.checked = !flexSwitchCheckVolume.checked;
          };

          document.getElementById('calibrationBeginButton').onclick = async () => {
            let invertedIR;
            const spinner = document.getElementById('spinner');
            const calibrationResult = document.getElementById('calibrationResult');

            const speakerParameters = {
              siteUrl: window.location.href.substring(0, location.href.lastIndexOf('/')),
              targetElementId: 'display',
            };

            const calibratorParams = {
              numCalibrationRounds: document.getElementById('numCalibrationRoundsInput').value,
              numCalibrationNodes: document.getElementById('numCalibrationNodesInput').value,
              download: document.getElementById('flexSwitchCheckDownload').checked,
            };

            const runVolumeCalibration = async () => {
              try {
                const dbSPL = await Speaker.startCalibration(
                  speakerParameters,
                  VolumeCalibration,
                  calibratorParams
                );
                calibrationResult.innerText = `Sound Gain ${dbSPL.toFixed(3)} dB SPL`;
                calibrationResult.classList.remove('d-none');
              } catch (err) {
                calibrationResult.innerText = `${err.name}: ${err.message}`;
              }
            };

            const runImpulseResponseCalibration = async () => {
              console.log({ calibratorParams });

              try {
              invertedIR = await Speaker.startCalibration(
                speakerParameters,
                ImpulseResponseCalibration,
                calibratorParams
              );
                /*
                invertedIR = [.001, 1, .01, 100, .1, 100, .001, 1, .01, 10, .1, 100, .001, 10, .01, .010, 010, .01,
                  1, .01, 10, .01, 1, .01, 10, .01, 1, .01, 10, .010, .01, 1, .1, 10, .00001, 10, .001, 1, .0001, 1,
                  .00001, 1, .0000001, 10, .000001, .001, 1, .01, 100, .1, 100, .001, 1, .01, 10, .1, 100, .001, 10,
                  .01, .010, 010, .01, 1, .01, 10, .01, 1, .01, 10, .01, 1, .01, 10, .010, .01, 1, .1, 10, .00001, 10,
                  .001, 1, .0001, 1, .00001, 1, .0000001, 10, .000001, .001, 1, .01, 100, .1, 100, .001, 1, .01, 10, .1,
                  100, .001, 10, .01, .010, 010, .01, 1, .01, 10, .01, 1, .01, 10, .01, 1, .01, 10, .010, .01, 1, .1, 10,
                  .00001, 10, .001, 1, .0001, 1, .00001, 1, .0000001, 10, .000001, .001, 1, .01, 100, .1, 100, .001, 1, .01,
                  10, .1, 100, .001, 10, .01, .010, 010, .01, 1, .01, 10, .01, 1, .01, 10, .01, 1, .01, 10, .010, .01, 1, .1,
                  10, .00001, 10, .001, 1, .0001, 1, .00001, 1, .0000001, 10, .000001, .001, 1, .01, 100, .1, 100, .001, 1, .01,
                  10, .1, 100, .001, 10, .01, .010, 010, .01, 1, .01, 10, .01, 1, .01, 10, .01, 1, .01, 10, .010, .01, 1, .1, 10,
                  .00001, 10, .001, 1, .0001, 1, .00001, 1, .0000001, 10, .000001,]
                  */
                // const invertedIR = cachedInvertedIR
                console.log({ invertedIR });
                await useIRResult(invertedIR)
              } catch (err) {
                calibrationResult.innerText = `${err.name}: ${err.message}`;
              }
            };

            if (flexSwitchCheckIR.checked) {
              runImpulseResponseCalibration();
            } else {
              runVolumeCalibration();
            }
          };
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
          crossorigin="anonymous"></script>
</body>

</html>