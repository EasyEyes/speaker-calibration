<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: listener.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: listener.js</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>import './listener.css';
import AudioPeer from './audioPeer';

/**
 * @class Handles the listener's side of the connection. Responsible for getting access to user's microphone,
 * and initiating a call to the Speaker.
 * @extends AudioPeer
 */
class Listener extends AudioPeer {
  /**
   * Takes a target element where html elements will be appended.
   * @param {initParameters} params - see type definition for initParameters
   */
  constructor(params) {
    super(params);

    this.startTime = Date.now();
    this.receiverPeerId = null;

    const urlParameters = this.parseURLSearchParams();
    this.speakerPeerId = urlParameters.speakerPeerId;

    this.peer.on('open', this.onPeerOpen);
    this.peer.on('connection', this.onPeerConnection);
    this.peer.on('disconnected', this.onPeerDisconnected);
    this.peer.on('close', this.onPeerClose);
    this.peer.on('error', this.onPeerError);
  }

  onPeerOpen = id => {
    console.log('Listener - onPeerOpen');
    // Workaround for peer.reconnect deleting previous id
    if (id === null) {
      console.log('Received null id from peer open');
      this.peer.id = this.lastPeerId;
    } else {
      this.lastPeerId = this.peer.id;
    }
    this.join();
  };

  onPeerConnection = connection => {
    console.log('Listener - onPeerConnection');
    // Disallow incoming connections
    connection.on('open', () => {
      connection.send('Sender does not accept incoming connections');
      setTimeout(() => {
        connection.close();
      }, 500);
    });
  };

  onConnData = data => {
    console.log('Listener - onConnData');
    // Keypad has received data, namely instructions to update the keypad
    // TODO generalize to a list of properies
    const hasSpeakerID = Object.prototype.hasOwnProperty.call(data, 'speakerPeerId');
    if (!hasSpeakerID) {
      console.error('Error in parsing data received! Must set "speakerPeerId" properties');
    } else {
      // this.conn.close();
      console.log(this.speakerPeerId);
      this.speakerPeerId = data.speakerPeerId;
      const newParams = {
        speakerPeerId: this.speakerPeerId,
      };
      /*
      FUTURE does this limit usable environments?
      ie does this work if internet is lost after initial page load?
      */
      window.location.search = this.queryStringFromObject(newParams); // Redirect to correctly constructed keypad page
    }
  };

  join = () => {
    console.log('Listener - join');
    /**
     * Create the connection between the two Peers.
     *
     * Sets up callbacks that handle any events related to the
     * connection and data received on it.
     */
    // Close old connection
    if (this.conn) {
      this.conn.close();
    }
    // Create connection to destination peer specified by the query param
    this.conn = this.peer.connect(this.speakerPeerId, {
      reliable: true,
    });

    this.conn.on('open', () => {
      // console.log("TODO Implement real on connection fn");
      this.openAudioStream();
    });

    // Handle incoming data (messages only since this is the signal sender)
    this.conn.on('data', this.onConnData);
    this.conn.on('close', () => {
      console.log('Connection closed');
    });
  };

  openAudioStream = async () => {
    navigator.mediaDevices
      .getUserMedia({video: false, audio: true})
      .then(stream => {
        this.peer.call(this.speakerPeerId, stream); // one-way call
        console.log('Listener - openAudioStream');
      })
      .catch(err => {
        console.log(`u got an error:${err}`);
      });
  };
}

export default Listener;
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Classes</h3>
      <ul>
        <li><a href="AudioCalibrator.html">AudioCalibrator</a></li>
        <li><a href="AudioPeer.html">AudioPeer</a></li>
        <li><a href="AudioRecorder.html">AudioRecorder</a></li>
        <li><a href="Listener.html">Listener</a></li>
        <li><a href="MlsGenInterface.html">MlsGenInterface</a></li>
        <li><a href="Speaker.html">Speaker</a></li>
      </ul>
      <h3><a href="global.html">Global</a></h3>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Tue
      Mar 01 2022 12:39:42 GMT-0500 (Eastern Standard Time)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
